name: Verify Release Artifacts

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to verify (e.g. v1.4.1). Required when run manually.'
        required: true
        type: string

permissions:
  contents: read

jobs:
  verify-standard-install:
    name: standard-install.yaml matches source at tag
    runs-on: ubuntu-latest
    # On release event: only SemVer tags; on manual run: always run (tag validated by input)
    if: github.event_name == 'workflow_dispatch' || startsWith(github.event.release.tag_name, 'v')
    steps:
      - name: Set tag for verification
        id: set-tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # tag=v6.1.0

      - name: Download release assets and source, build, and compare
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.set-tag.outputs.tag }}
          REPO: ${{ github.repository }}
        run: |
          echo "TAG: $TAG"
          set -e
          workdir=$(mktemp -d)
          cd "$workdir"

          # Get standard-install.yaml from the release
          gh release download "$TAG" --repo "$REPO" --pattern "standard-install.yaml" --dir .

          if ! gh release download "$TAG" --repo "$REPO" --pattern "*.tar.gz" --dir . 2>/dev/null; then
            curl -sSfL -o source.tar.gz "https://github.com/${REPO}/archive/refs/tags/${TAG}.tar.gz"
            tar --extract --gunzip --file source.tar.gz
            echo ">>>> 1"
          else
            tar --extract --gunzip --file $(ls *.tar.gz | head -1)
            echo ">>>> 2"
          fi

          cd gateway-api-*
          make build-install-yaml

          # Normalize copyright year so we only fail on real content differences
          sed 's/Copyright [0-9]\{4\}/Copyright YEAR/' ../standard-install.yaml > /tmp/release.yaml
          sed 's/Copyright [0-9]\{4\}/Copyright YEAR/' release/standard-install.yaml > /tmp/built.yaml

          if ! diff -u /tmp/release.yaml /tmp/built.yaml; then
            echo ""
            echo "::error::standard-install.yaml in the release does not match the source at tag $TAG."
            exit 1
          fi
          echo "Release artifact matches source at tag. Verification passed."
