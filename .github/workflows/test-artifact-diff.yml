name: Verify Release Artifacts

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to verify (e.g. v1.4.1). Required when run manually.'
        required: true
        type: string

permissions:
  contents: read

jobs:
  verify-standard-install:
    name: standard-install.yaml matches source at tag
    runs-on: ubuntu-latest
    # On release event: only SemVer tags; on manual run: always run (tag validated by input)
    if: github.event_name == 'workflow_dispatch' || startsWith(github.event.release.tag_name, 'v')
    steps:
      - name: Set tag for verification
        id: set-tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # tag=v6.1.0

      - name: Download release assets and source, build, and compare
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.set-tag.outputs.tag }}
          REPO: ${{ github.repository }}
        run: |
          set -e
          echo "Verifying tag: $TAG"
          echo "Comparing: (A) standard-install.yaml from release $TAG  vs  (B) standard-install.yaml built from source at $TAG"
          echo ""

          workdir=$(mktemp -d)
          cd "$workdir"

          # A) Get standard-install.yaml FROM the release assets (this is what users download)
          gh release download "$TAG" --repo "$REPO" --pattern "standard-install.yaml" --dir .
          echo "Downloaded standard-install.yaml from release $TAG"

          # B) Always get source from the Git archive at this exact tag (never from release assets)
          # so we build from the same version we are verifying
          curl -sSfL -o source.tar.gz "https://github.com/${REPO}/archive/refs/tags/${TAG}.tar.gz"
          tar --extract --gunzip --file source.tar.gz
          cd gateway-api-*
          echo "Building standard-install.yaml from source at tag $TAG (same version)..."
          make build-install-yaml

          # B) Built file is in release/standard-install.yaml
          # Normalize copyright year so we only fail on real content differences
          sed 's/Copyright [0-9]\{4\}/Copyright YEAR/' ../standard-install.yaml > /tmp/release.yaml
          sed 's/Copyright [0-9]\{4\}/Copyright YEAR/' release/standard-install.yaml > /tmp/built.yaml

          echo ""
          echo "Diff: (A) release asset  vs  (B) built from source. Lines with - are in release, + are in built."
          if ! diff -u /tmp/release.yaml /tmp/built.yaml; then
            echo ""
            echo "::error::Release $TAG: standard-install.yaml in the release does not match the source at tag $TAG."
            echo "The release artifact may have been built from a different commit (e.g. main ahead of the tag). See https://github.com/kubernetes-sigs/gateway-api/issues/4490"
            exit 1
          fi
          echo "Release artifact matches source at tag $TAG. Verification passed."
